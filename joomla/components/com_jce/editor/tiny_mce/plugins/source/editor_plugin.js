(function(){var each=tinymce.each,ACE;tinymce.create('tinymce.plugins.Source',{init:function(ed,url){var self=this,DOM=tinymce.DOM;this.editor=ed;this.url=url;this.settings=tinymce.settings;this.active=[];ed.addCommand('mceSource',function(){self.toggleSource()});this.state=false;this.highlight=ed.getParam('source_higlight',1);this.numbers=ed.getParam('source_numbers',1);this.wrap=ed.getParam('source_wrap',1);if(ed.onContextMenu){cMenu=ed.onContextMenu.addToTop(function(ed,e){if(ed.plugins.source.state){return false}})}ed.onBeforeExecCommand.add(function(ed,cmd,ui,val,o){var cm=ed.controlManager;if(self.state&&self.highlight&&ACE){if(cmd=='Undo'){o.terminate=true;ACE.undo();cm.setDisabled('redo',false);return true}if(cmd=='Redo'){o.terminate=true;ACE.redo();cm.setDisabled('redo',true);return true}}if(cmd=='mcePrint'){if(self.state){o.terminate=true;return self.printSource()}}});ed.onGetContent.add(function(ed,o){if(self.getState()){o.content=self.getContent()}});ed.onLoadContent.add(function(ed,o){if(self.getState()){self.setContent();self.reInit()}});ed.onSaveContent.add(function(ed,o){if(self.getState()){o.content=self.getContent()}});ed.onExecCommand.add(function(ed,cmd,ui,v,o){function _disable(){window.setTimeout(function(){self.toggleDisabled()},0)}switch(cmd){case'mceCodeEditor':case'mceSource':_disable();break;case'mceFullScreen':if(self.getState()){_disable();var fs=ed.plugins.fullscreen;var w=fs.getWidth(),h=fs.getHeight();self.resize(w,h)}break;case'mceInsertContent':if(self.getState()){o.terminate=true;_disable();self.setContent(v)}break}});ed.addButton('source',{title:'source.source_desc',cmd:'mceSource'});ed.addButton('wrap',{title:'source.wrap_desc',onclick:function(){self.setWrap(!self.wrap);return true}});ed.addButton('highlight',{title:'source.highlight_desc',onclick:function(){self.setHighlight(!self.highlight);return true}});ed.addButton('numbers',{title:'source.numbers_desc',onclick:function(){self.setNumbers(!self.numbers);return true}});ed.onNodeChange.add(function(ed,cm,n){var s=self.getState();cm.setDisabled('wrap',!s);cm.setDisabled('highlight',!s);cm.setDisabled('numbers',!s)});ed.theme.onResize.add(function(){self.resize()})},getState:function(){return this.state},setState:function(s){this.state=s},getTop:function(){var ed=this.editor,container=ed.getContentAreaContainer();return container.offsetTop+Math.round((container.offsetHeight-container.clientHeight)/2)},printSource:function(){var self=this,ed=this.editor,DOM=tinymce.DOM,content='';var iframe=DOM.get(ed.id+'_ifr'),print=DOM.get(ed.id+'_source_print');if(ACE){if(!print){var print=DOM.create('iframe',{src:'javascript:""',id:ed.id+'_source_print',style:{position:'absolute',top:this.getTop()}});print.style.visibility='hidden';var parent=iframe.parentNode;parent.insertBefore(print,iframe)}var doc=print.contentWindow.document;content+=ed.settings.doctype+'<html><head xmlns="http://www.w3.org/1999/xhtml">';content+='<meta http-equiv="X-UA-Compatible" content="IE=edge" />';content+='<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />';var theme=this.highlight?'textmate':'';each(['editor',theme],function(s){if(s){content+='<link type="text/css" rel="stylesheet" href="'+self.url+'/css/ace/'+s+'.css" />'}});content+='</head><body><div style="position:relative;"><div class="'+ACE.renderer.getContainerElement().className+'">'+DOM.getOuterHTML(DOM.select('div.ace_layer.ace_text-layer',ACE.renderer.getContainerElement())[0])+'</div></div></body></html>';doc.open();doc.write(content);doc.close()}print.contentWindow.print()},reInit:function(){this.toggleDisabled();if(this.getState()&&ACE){ACE.focus()}},setContent:function(v){var ed=this.editor,DOM=tinymce.DOM;if(typeof v=='undefined'){v=ed.getContent({no_events:true})}if(ACE){ACE.getSession().setUseWrapMode(false);v=this.indent(DOM.decode(v));ACE.getSession().setValue(v);if(ACE){ACE.getSession().setUseWrapMode(this.wrap)}}},getContent:function(){var ed=this.editor,DOM=tinymce.DOM;if(ACE){if(ACE){ACE.getSession().setUseWrapMode(false)}return ACE.getSession().getValue()}},resize:function(w,h){if(!this.state)return;var self=this,ed=this.editor,DOM=tinymce.DOM,ifr=DOM.get(ed.id+'_ifr');w=parseFloat(w)||ifr.clientWidth;h=parseFloat(h)||ifr.clientHeight;if(ACE){DOM.setStyles(ACE.renderer.getContainerElement(),{'width':w,'height':h});ACE.resize()}},toggleDisabled:function(){var self=this,ed=this.editor,DOM=tinymce.DOM,cm=ed.controlManager;var state=this.getState();var active=DOM.select('.mceButtonActive:not(a.mce_highlight, a.mce_numbers, a.mce_wrap)',ed.getContainer());if(!state){DOM.remove(DOM.get(ed.id+'_source_print'));each(['wrap','highlight','numbers'],function(e){cm.setActive(e,false)})}each(active,function(n){cm.setActive(n.id,!state)});each(DOM.select('.mceButton, .mceListBox, .mceSplitButton',ed.getContainer()),function(n){cm.setDisabled(n.id,state)});cm.setActive('source',state);cm.setActive('fullscreen',DOM.hasClass(ed.getContainer(),'fullscreen'));cm.setDisabled('source',false);cm.setDisabled('fullscreen',false);each(['wrap','highlight','numbers'],function(e){cm.setDisabled(e,!state)})},toggleSource:function(){var self=this,ed=this.editor,DOM=tinymce.DOM,cm=ed.controlManager,textarea,cMenu;var state=this.getState();var iframe=DOM.get(ed.id+'_ifr');var element=ed.getElement();this.setState(!state);if(!state){var w=parseFloat(iframe.clientWidth);var h=parseFloat(iframe.clientHeight);DOM.hide(ed.id+'_path_row');DOM.hide(DOM.get(ed.id+'-word-count').parentNode);DOM.addClass(iframe,'hidden');DOM.setAttrib(iframe,'aria-hidden',true);this.setHighlight(this.highlight)}else{if(ACE){ed.setContent(self.getContent());DOM.hide(ACE.renderer.getContainerElement());DOM.setAttrib(ACE.renderer.getContainerElement(),'aria-hidden',true)}DOM.removeClass(iframe,'hidden');iframe.removeAttribute('aria-hidden');DOM.show(ed.id+'_path_row');DOM.show(DOM.get(ed.id+'-word-count').parentNode);ed.focus();ed.setProgressState(false)}},loadACE:function(){var self=this,ed=this.editor,url=this.url,DOM=tinymce.DOM,iframe=DOM.get(ed.id+'_ifr');var container=iframe.parentNode;var theme='textmate';var container=DOM.create('div',{role:'textbox',style:{position:'absolute',top:this.getTop(),width:iframe.clientWidth,height:iframe.clientHeight},'class':'WFSourceEditor'});var parent=iframe.parentNode;parent.insertBefore(container,iframe);var query=ed.getParam('site_url')+'index.php?option=com_jce';var args={'view':'editor','layout':'plugin','plugin':'source','theme':theme};var token=DOM.get('wf_'+ed.id+'_token');if(!token){alert('INVALID TOKEN');return false}args[token.name]=token.value;for(k in args){query+='&'+k+'='+encodeURIComponent(args[k])}self._loadCSS(query+'&type=css',function(){var loader=new tinymce.dom.ScriptLoader();loader.add(query+'&type=js');loader.loadQueue(function(){window.setTimeout(function(){ACE=ace.edit(container);ACE.setTheme('ace/theme/'+theme);var mode=require("ace/mode/text").Mode;if(self.highlight){mode=require("ace/mode/html").Mode}ACE.getSession().setMode(new mode());ACE.setShowPrintMargin(false);self.setContent();self.setWrap(self.wrap);self.setNumbers(self.numbers);if(tinymce.isIE&&!document.querySelector){ed.hide();ed.show()}ed.setProgressState(false)},0)})})},indent:function(h){h=h.replace(/<(\/?)(ul|hr|table|meta|link|tbody|tr|object|audio|video|body|head|html|map)(|[^>]+)>\s*/g,'\n<$1$2$3>\n');h=h.replace(/\s*<(p|h[1-6]|blockquote|div|title|style|pre|script|td|li|area|param|source)(|[^>]+)>/g,'\n<$1$2>');h=h.replace(/<\/(p|h[1-6]|blockquote|div|title|style|pre|script|td|li)>\s*/g,'</$1>\n');h=h.replace(/\n\n/g,'\n');h=h.replace(/<!--\[if([^\]]*)\]>(<!)?-->/gi,'\n<!--[if$1]>$2-->');h=h.replace(/<!(--<!)?\[endif\](--)?>/gi,'<!$1[endif]$2>\n');return tinymce.trim(h)},setHighlight:function(s){var ed=this.editor,DOM=tinymce.DOM,v,n,cm=ed.controlManager;cm.setActive('highlight',!!s);if(ACE){ACE.getSession().setUseWrapMode(false);if(s){var html=require("ace/mode/html").Mode;ACE.getSession().setMode(new html())}else{var text=require("ace/mode/text").Mode;ACE.getSession().setMode(new text())}this.setContent();ACE.getSession().setUseWrapMode(this.wrap);DOM.show(ACE.renderer.getContainerElement());this.resize();ed.setProgressState(false)}else{ed.setProgressState(true);this.loadACE()}this.setNumbers(this.numbers);this.setWrap(this.wrap);this.highlight=!!s},setWrap:function(s){var ed=this.editor,DOM=tinymce.DOM,v,n;var cm=ed.controlManager;this.wrap=!!s;cm.setActive('wrap',this.wrap);if(ACE){ACE.getSession().setUseWrapMode(this.wrap);ACE.focus()}},setNumbers:function(s){var cm=this.editor.controlManager;this.numbers=!!s;cm.setActive('numbers',this.numbers);if(ACE){return ACE.renderer.setShowGutter(this.numbers)}},_loadCSS:function(url,callback){var self=this,ed=this.editor,DOM=tinymce.DOM,id=DOM.uniqueId(),cssTimeout;var head=DOM.select('head')[0];if(DOM.get(id)){callback();return}var link=DOM.create('link',{rel:'stylesheet',type:'text/css',href:tinymce._addVer(url),id:id});if(tinymce.isIE){link.onreadystatechange=function(){/loaded|complete/.test(link.readyState)&&callback()}}else if(window.opera&&'onload'in link){link.onload=function(){callback()}}else{(function(){if(/http(s)?:\/\//i.test(url)&&url.indexOf(tinymce.settings.document_base_url)==-1){cssTimeout=window.setTimeout(function(){window.clearTimeout(cssTimeout);callback()},1000);return}try{link.sheet.cssRules}catch(e){cssTimeout=window.setTimeout(arguments.callee,20);return}window.clearTimeout(cssTimeout);callback()})()}head.appendChild(link)},getInfo:function(){return{longname:'Source',author:'Ryan Demmer',authorurl:'http://www.joomlacontenteditor.net',infourl:'http://www.joomlacontenteditor.net',version:'2.0.0beta7'}}});tinymce.PluginManager.add('source',tinymce.plugins.Source)})();